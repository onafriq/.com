<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - MFS AFRICA LTD</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f1f5f4;
      margin: 0;
      padding: 20px;
    }

    .admin-dashboard {
      max-width: 1000px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    h2 {
      color: #A000FF;
      margin-bottom: 20px;
    }

    .logout-btn {
      float: right;
      background: #444;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
    }

    .stats {
      margin-bottom: 10px;
      font-size: 16px;
    }

    #searchInput {
      padding: 8px;
      width: 100%;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .user-cards {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .user-card {
      background: #fdfdfd;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .user-card div {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .user-card label {
      font-weight: bold;
      margin-right: 5px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .edit-btn {
      background-color: #f0ad4e;
      color: white;
    }

    .delete-btn {
      background-color: #d9534f;
      color: white;
    }

    .save-btn {
      background-color: #5cb85c;
      color: white;
    }

    .cancel-btn {
      background-color: #6c757d;
      color: white;
    }

    .edit-input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    .withdrawals {
      margin-top: 50px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }

    table th {
      background-color: #6c2bd9;
      color: white;
    }

    table tr:hover {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="admin-dashboard">
    <button class="logout-btn" onclick="logout()">Log Out</button>
    <h2>Admin Dashboard</h2>

    <div class="stats">Total users: <span id="userCount">0</span></div>

    <input type="text" id="searchInput" placeholder="Search users..." oninput="loadUsers()">

    <div id="userCardContainer" class="user-cards"></div>

    <div class="withdrawals">
      <h2>Withdrawal Requests</h2>
      <table id="withdrawalTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Username</th>
            <th>Phone</th>
            <th>Amount (RWF)</th>
            <th>Method</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCbuLoyGu6v7dJUDQ0iM2DkvEZs0D9z2Do",
      authDomain: "mfs-africa-ltd.firebaseapp.com",
      databaseURL: "https://mfs-africa-ltd-default-rtdb.firebaseio.com",
      projectId: "mfs-africa-ltd",
      storageBucket: "mfs-africa-ltd.appspot.com",
      messagingSenderId: "686833267635",
      appId: "1:686833267635:web:c5a531346887f6452bd1c6"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function logout() {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }

    function loadUsers() {
      const container = document.getElementById('userCardContainer');
      const userCount = document.getElementById('userCount');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      database.ref('users').once('value', (snapshot) => {
        const users = snapshot.val() || {};
        const userList = Object.entries(users).map(([id, data]) => ({ id, ...data }));

        const filtered = userList.filter(user =>
          user.name?.toLowerCase().includes(searchTerm) ||
          user.username?.toLowerCase().includes(searchTerm) ||
          user.email?.toLowerCase().includes(searchTerm)
        );

        container.innerHTML = '';
        filtered.forEach((user) => {
          const card = document.createElement('div');
          card.className = 'user-card';
          card.setAttribute('id', `card-${user.id}`);

          card.innerHTML = `
            <div><label>Full Name:</label><span class="field name">${user.name || ''}</span></div>
            <div><label>Username:</label><span class="field username">${user.username || ''}</span></div>
            <div><label>Email:</label><span class="field email">${user.email || ''}</span></div>
            <div><label>Balance:</label><span class="field balance">${user.balance || 0}</span></div>
            <div><label>Deposit:</label><span class="field deposit">${user.deposit || 0}</span></div>
            <div><label>Bonus:</label><span class="field bonus">${user.bonus || 0}</span></div>
            <div><label>Earnings:</label><span class="field earnings">${user.earnings || 0}</span></div>
            <div><label>Password:</label><span class="field password">${user.password || ''}</span></div>

            <div class="action-buttons" id="buttons-${user.id}">
              ${
                user.active
                  ? `<button class="btn edit-btn" onclick="editUser('${user.id}')">Edit</button>
                     <button class="btn delete-btn" onclick="deleteUser('${user.id}')">Delete</button>`
                  : `<button class="btn save-btn" onclick="activateUser('${user.id}')">Activate</button>
                     <button class="btn delete-btn" onclick="rejectUser('${user.id}')">Reject</button>`
              }
            </div>
          `;
          container.appendChild(card);
        });

        userCount.textContent = filtered.length;
      });
    }

    function editUser(userId) {
      const card = document.getElementById(`card-${userId}`);
      const fields = card.querySelectorAll('.field');

      fields.forEach(field => {
        const value = field.textContent;
        const className = field.classList[1];
        field.outerHTML = `<input class="edit-input" data-key="${className}" value="${value}" />`;
      });

      const buttonDiv = document.getElementById(`buttons-${userId}`);
      buttonDiv.innerHTML = `
        <button class="btn save-btn" onclick="saveUser('${userId}')">Save</button>
        <button class="btn cancel-btn" onclick="loadUsers()">Cancel</button>
      `;
    }

    function saveUser(userId) {
      const card = document.getElementById(`card-${userId}`);
      const inputs = card.querySelectorAll('.edit-input');

      const updatedData = {};
      inputs.forEach(input => {
        const key = input.getAttribute('data-key');
        updatedData[key] = input.value;
      });

      database.ref('users/' + userId).update(updatedData)
        .then(() => {
          alert('User updated!');
          loadUsers();
        })
        .catch(error => {
          console.error('Error updating user:', error);
        });
    }

    function deleteUser(userId) {
      if (confirm("Are you sure you want to delete this user?")) {
        database.ref('users/' + userId).remove().then(loadUsers);
      }
    }

    function activateUser(userId) {
      if (confirm('Activate this user?')) {
        database.ref('users/' + userId).update({ active: true })
          .then(() => {
            alert('User activated!');
            loadUsers();
          })
          .catch(error => {
            console.error('Error activating user:', error);
            alert('Failed to activate user.');
          });
      }
    }

    function rejectUser(userId) {
      if (confirm('Reject this user? This will delete their data.')) {
        database.ref('users/' + userId).remove()
          .then(() => {
            alert('User rejected and removed.');
            loadUsers();
          })
          .catch(error => {
            console.error('Error rejecting user:', error);
            alert('Failed to reject user.');
          });
      }
    }

    function loadWithdrawals() {
      const tbody = document.querySelector('#withdrawalTable tbody');
      database.ref('withdrawals').on('value', (snapshot) => {
        const data = snapshot.val();
        tbody.innerHTML = '';

        if (data) {
          Object.entries(data).forEach(([id, entry]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${entry.name || ''}</td>
              <td>${entry.username || ''}</td>
              <td>${entry.phone || ''}</td>
              <td>${entry.amount || 0}</td>
              <td>${entry.method || 'MTN'}</td>
              <td>${new Date(entry.timestamp).toLocaleString()}</td>
              <td><button class="btn save-btn" onclick="approveWithdrawal('${id}')">Approve</button></td>
            `;
            tbody.appendChild(row);
          });
        }
      });
    }

    function approveWithdrawal(withdrawalId) {
      if (!confirm("Approve this withdrawal?")) return;

      const withdrawalRef = database.ref('withdrawals/' + withdrawalId);

      withdrawalRef.once('value').then(snapshot => {
        const withdrawal = snapshot.val();
        if (!withdrawal) return;

        const userId = withdrawal.userId;
        const amount = withdrawal.amount;

        const userRef = database.ref('users/' + userId);

        userRef.once('value').then(userSnap => {
          const userData = userSnap.val();
          const currentPending = userData.pending || 0;
          const newPending = currentPending - amount;

          userRef.update({ pending: newPending >= 0 ? newPending : 0 }).then(() => {
            withdrawalRef.remove().then(() => {
              alert("Withdrawal approved and user's pending updated.");
              loadWithdrawals();
            });
          });
        });
      }).catch(error => {
        console.error("Error during withdrawal approval:", error);
        alert("Something went wrong while approving.");
      });
    }

    loadUsers();
    loadWithdrawals();
  </script>
</body>
</html>