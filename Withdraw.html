    const error = document.getElementById('error');

    let currentBonus = 0;
    let userId = null;
    let username = '';

    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        db.ref("users/" + userId).once("value")
          .then(snapshot => {
            const userData = snapshot.val();
            currentBonus = userData.bonus || 0;
            username = userData.username || '';
            bonusDisplay.textContent = "Bonus Available: RWF " + currentBonus;
          });
      } else {
        alert("You must be logged in to withdraw funds.");
        window.location.href = "login.html";
      }
    });

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      error.textContent = '';
      message.textContent = '';
      spinner.style.display = 'block';

      const amount = parseInt(document.getElementById('amount').value);
      const phone = document.getElementById('recipient').value.trim();
      const name = document.getElementById('owner').value.trim();

      if (amount > currentBonus) {
        spinner.style.display = 'none';
        error.textContent = "Insufficient bonus balance.";
        return;
      }

      const withdrawalData = {
        userId: userId,
        username: username,
        amount: amount,
        phone: phone,
        name: name,
        status: "pending",
        timestamp: Date.now()
      };

      const userRef = db.ref("users/" + userId);

      db.ref("withdrawals").push(withdrawalData)
        .then(() => {
          return userRef.once("value");
        })
        .then(snapshot => {
          const userData = snapshot.val();
          const currentPending = userData.pending || 0;
          const newBonus = (userData.bonus || 0) - amount;
          const newPending = currentPending + amount;

          return userRef.update({
            bonus: newBonus,
            pending: newPending
          });
        })
        .then(() => {
          spinner.style.display = 'none';
          message.textContent = "Withdrawal request submitted successfully!";
          form.reset();
          currentBonus -= amount;
          bonusDisplay.textContent = "Bonus Available: RWF " + currentBonus;
        })
        .catch(err => {
          spinner.style.display = 'none';
          error.textContent = "Failed to submit withdrawal request.";
          console.error(err);
        });
    });
  </script>
</body>
</html>